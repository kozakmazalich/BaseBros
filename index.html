<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BaseBros - Farcaster Greeter</title>
    
    <!-- Farcaster Mini App Meta Tags -->
    <meta name="fc:frame" content='{"version":"next","imageUrl":"https://placehold.co/1200x630/8a63d2/white?text=BaseBros","button":{"title":"Open BaseBros","action":{"type":"launch_frame","url":"https://base-bros.vercel.app/"}}}' />
    <meta name="fc:miniapp" content='{"version":"next","imageUrl":"https://placehold.co/1200x630/8a63d2/white?text=BaseBros","button":{"title":"Open BaseBros","action":{"type":"launch_frame","url":"https://base-bros.vercel.app/"}}}' />
    
    <style>
        :root {
            --primary-color: #8a63d2;
            --secondary-color: #6C47FF;
            --text-color: #333;
            --light-bg: #f8f9fa;
            --border-radius: 12px;
            --shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
        }

        body {
            background-color: var(--light-bg);
            color: var(--text-color);
            line-height: 1.5;
            padding: 16px;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
        }

        .basebros-card {
            background: white;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            padding: 24px;
            max-width: 400px;
            width: 100%;
        }

        .header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 16px;
        }

        .logo {
            font-weight: bold;
            font-size: 1.5rem;
            color: var(--primary-color);
        }

        .farcaster-badge {
            background-color: var(--primary-color);
            color: white;
            font-size: 0.75rem;
            padding: 4px 8px;
            border-radius: 20px;
            font-weight: bold;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 20px;
            padding: 16px;
            background-color: var(--light-bg);
            border-radius: var(--border-radius);
        }

        .avatar {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 1.2rem;
        }

        .user-details {
            flex: 1;
        }

        .user-name {
            font-weight: bold;
            font-size: 1.1rem;
            margin-bottom: 4px;
        }

        .user-stats {
            font-size: 0.875rem;
            color: #666;
            display: flex;
            gap: 12px;
        }

        .stat {
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .greeting-section {
            margin-bottom: 20px;
        }

        .greeting {
            font-size: 1.25rem;
            margin-bottom: 16px;
            line-height: 1.4;
            padding: 12px;
            background-color: #f0f4ff;
            border-radius: var(--border-radius);
            border-left: 4px solid var(--primary-color);
        }

        .emoji-buttons {
            display: flex;
            gap: 12px;
            margin-bottom: 20px;
        }

        .emoji-btn {
            background: none;
            border: 2px solid #e0e0e0;
            border-radius: 50%;
            width: 48px;
            height: 48px;
            font-size: 1.5rem;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .emoji-btn:hover, .emoji-btn:focus {
            border-color: var(--primary-color);
            transform: scale(1.1);
        }

        .emoji-btn.selected {
            border-color: var(--primary-color);
            background-color: rgba(138, 99, 210, 0.1);
        }

        .text-reply {
            margin-bottom: 16px;
        }

        .text-reply textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: var(--border-radius);
            resize: vertical;
            min-height: 80px;
            font-size: 1rem;
        }

        .text-reply textarea:focus {
            outline: none;
            border-color: var(--primary-color);
        }

        .submit-btn {
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: var(--border-radius);
            padding: 12px 24px;
            font-size: 1rem;
            font-weight: bold;
            cursor: pointer;
            width: 100%;
            transition: background-color 0.2s;
        }

        .submit-btn:hover, .submit-btn:focus {
            background-color: var(--secondary-color);
        }

        .submit-btn:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }

        .submit-btn.sending {
            background-color: #999;
            cursor: not-allowed;
        }

        .loading {
            text-align: center;
            padding: 20px;
        }

        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid var(--primary-color);
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
            margin: 0 auto 16px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .user-list {
            margin-top: 16px;
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid #e0e0e0;
            border-radius: var(--border-radius);
            padding: 8px;
        }

        .user-item {
            padding: 8px 12px;
            border-radius: 6px;
            cursor: pointer;
            margin-bottom: 4px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .user-item:hover {
            background-color: #f0f4ff;
        }

        .user-item.selected {
            background-color: rgba(138, 99, 210, 0.1);
            border-left: 3px solid var(--primary-color);
        }

        .user-item-avatar {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.75rem;
            font-weight: bold;
        }

        .toast {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            background-color: var(--primary-color);
            color: white;
            padding: 12px 24px;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            opacity: 0;
            transition: all 0.3s ease;
            z-index: 1000;
        }

        .toast.error {
            background-color: #e74c3c;
        }

        .toast.show {
            transform: translateX(-50%) translateY(0);
            opacity: 1;
        }

        @media (max-width: 480px) {
            .basebros-card {
                padding: 20px;
            }
            
            .emoji-btn {
                width: 44px;
                height: 44px;
            }
        }
    </style>
</head>
<body>
    <div class="basebros-card">
        <div class="header">
            <div class="logo">BaseBros</div>
            <div class="farcaster-badge">Farcaster</div>
        </div>

        <!-- Loading state -->
        <div id="loadingState" class="loading">
            <div class="spinner"></div>
            <p id="loadingText">Loading your Farcaster profile...</p>
        </div>

        <!-- Current User Info -->
        <div id="currentUserInfo" class="user-info" style="display: none;">
            <div class="avatar" id="currentUserAvatar">U</div>
            <div class="user-details">
                <div class="user-name" id="currentUserName">Loading...</div>
                <div style="font-size: 0.875rem; color: #666;">Ready to send greetings!</div>
            </div>
        </div>

        <!-- User selection section -->
        <div id="userSelection" style="display: none;">
            <div style="margin-bottom: 16px;">
                <h3 style="margin-bottom: 8px;">Select a BaseBro to greet:</h3>
                <p style="font-size: 0.875rem; color: #666; margin-bottom: 12px;">
                    Active Farcaster users this week
                </p>
            </div>
            
            <div class="user-list" id="userList">
                <!-- User list will be populated by JavaScript -->
            </div>
        </div>

        <!-- Selected user info -->
        <div id="selectedUserInfo" class="user-info" style="display: none;">
            <div class="avatar" id="userAvatar">U</div>
            <div class="user-details">
                <div class="user-name" id="userName">User Name</div>
                <div class="user-stats">
                    <div class="stat" id="userPosts">üìù 0 posts</div>
                    <div class="stat" id="userFollowers">üë• 0 followers</div>
                </div>
            </div>
        </div>

        <!-- Greeting section -->
        <div id="greetingSection" class="greeting-section" style="display: none;">
            <div class="greeting" id="greetingText">
                Hi, ma BaseBro, nice to meet you ‚Äî how'er you feeling about Base App?
            </div>

            <div class="emoji-buttons">
                <button class="emoji-btn" aria-label="Thumbs up" data-emoji="üëç">üëç</button>
                <button class="emoji-btn" aria-label="Smiling face" data-emoji="üòÑ">üòÑ</button>
                <button class="emoji-btn" aria-label="Thinking face" data-emoji="ü§î">ü§î</button>
                <button class="emoji-btn" aria-label="Confused face" data-emoji="üòï">üòï</button>
            </div>

            <div class="text-reply">
                <label for="replyText" style="display: block; margin-bottom: 8px;">Add a personal message (optional):</label>
                <textarea id="replyText" placeholder="Add something personal to your greeting..."></textarea>
            </div>

            <button id="submitBtn" class="submit-btn" disabled>Send Greeting via Farcaster</button>
        </div>

        <!-- Success message -->
        <div id="successMessage" style="display: none; text-align: center; padding: 20px;">
            <div style="font-size: 3rem; margin-bottom: 16px;">üéâ</div>
            <h3 style="margin-bottom: 8px;">Greeting Sent!</h3>
            <p style="color: #666;">Your message has been sent via Farcaster</p>
            <button id="sendAnotherBtn" class="submit-btn" style="margin-top: 16px;">Send Another Greeting</button>
        </div>
    </div>

    <!-- Toast notification -->
    <div id="toast" class="toast">Greeting sent via Farcaster!</div>

    <script>
        // =============================================================================
        // FARCASTER MINI APP SDK - CORRECT IMPLEMENTATION
        // =============================================================================
        
        let farcasterSDK = null;
        let currentUser = null;

        // Initialize Farcaster Mini App SDK
        async function initializeFarcasterSDK() {
            try {
                console.log('üöÄ Initializing Farcaster Mini App SDK...');

                // Method 1: Use Farcaster Frame SDK
                if (window.farcaster) {
                    farcasterSDK = window.farcaster;
                    console.log('‚úÖ Farcaster SDK found in window.farcaster');
                }
                
                // Method 2: Use Base SDK (if in Base environment)
                else if (window.sdk) {
                    farcasterSDK = window.sdk;
                    console.log('‚úÖ Using Base SDK as Farcaster SDK');
                }
                
                // Method 3: Try to import dynamically
                else {
                    try {
                        // This is the correct way to import Farcaster Mini App SDK
                        const { sdk } = await import('https://unpkg.com/@farcaster/frame-sdk@0.2.2');
                        farcasterSDK = sdk;
                        console.log('‚úÖ Farcaster SDK loaded dynamically');
                    } catch (importError) {
                        console.log('Dynamic import failed, using mock data');
                        // Fallback to mock data for development
                        farcasterSDK = createMockSDK();
                    }
                }

                // Get current user from SDK
                if (farcasterSDK && farcasterSDK.client && farcasterSDK.client.frame) {
                    const context = await farcasterSDK.client.frame.getContext();
                    currentUser = context.user;
                    console.log('‚úÖ Current user from Farcaster:', currentUser);
                } else {
                    // Fallback: create mock user
                    currentUser = {
                        fid: 12345,
                        username: 'basebro',
                        displayName: 'BaseBro User',
                        pfpUrl: null
                    };
                    console.log('‚úÖ Using mock user data');
                }

                // Call ready to dismiss splash screen
                if (farcasterSDK.actions && farcasterSDK.actions.ready) {
                    await farcasterSDK.actions.ready();
                    console.log('‚úÖ Farcaster SDK ready() called');
                }

                return true;

            } catch (error) {
                console.error('‚ùå Farcaster SDK initialization failed:', error);
                // Fallback to mock mode
                currentUser = {
                    fid: 12345,
                    username: 'basebro',
                    displayName: 'BaseBro User',
                    pfpUrl: null
                };
                return true;
            }
        }

        // Mock SDK for development
        function createMockSDK() {
            return {
                client: {
                    frame: {
                        getContext: async () => ({
                            user: {
                                fid: 12345,
                                username: 'basebro',
                                displayName: 'BaseBro User',
                                pfpUrl: null
                            }
                        })
                    }
                },
                actions: {
                    ready: async () => {
                        console.log('‚úÖ Mock SDK ready() called');
                    },
                    sendCast: async (cast) => {
                        console.log('üì§ Mock cast sent:', cast);
                        return { hash: '0x' + Math.random().toString(16).substr(2, 64) };
                    }
                }
            };
        }

        // =============================================================================
        // APP LOGIC
        // =============================================================================

        const greetingVariants = [
            "Hi, ma BaseBro, nice to meet you ‚Äî how'er you feeling about Base App?",
            "Hey there BaseBro! What's your vibe with Base App these days?",
            "Yo BaseBro! How's Base App treating you lately?",
            "Hey BaseBro! What's cooking in your Base App world?",
            "Hi BaseBro! How's life on Base treating you?"
        ];

        // DOM elements
        const loadingState = document.getElementById('loadingState');
        const loadingText = document.getElementById('loadingText');
        const currentUserInfo = document.getElementById('currentUserInfo');
        const currentUserAvatar = document.getElementById('currentUserAvatar');
        const currentUserName = document.getElementById('currentUserName');
        const userSelection = document.getElementById('userSelection');
        const userList = document.getElementById('userList');
        const selectedUserInfo = document.getElementById('selectedUserInfo');
        const userAvatar = document.getElementById('userAvatar');
        const userName = document.getElementById('userName');
        const userPosts = document.getElementById('userPosts');
        const userFollowers = document.getElementById('userFollowers');
        const greetingSection = document.getElementById('greetingSection');
        const greetingText = document.getElementById('greetingText');
        const emojiButtons = document.querySelectorAll('.emoji-btn');
        const replyText = document.getElementById('replyText');
        const submitBtn = document.getElementById('submitBtn');
        const successMessage = document.getElementById('successMessage');
        const sendAnotherBtn = document.getElementById('sendAnotherBtn');
        const toast = document.getElementById('toast');

        // State
        let selectedEmoji = null;
        let selectedUser = null;
        let activeUsers = [];

        // Initialize the app
        async function init() {
            try {
                console.log('üöÄ Starting BaseBros Farcaster Mini App...');
                
                // STEP 1: Initialize Farcaster SDK and get user
                await initializeFarcasterSDK();
                
                // STEP 2: Show current user
                showCurrentUser();
                
                // STEP 3: Load active users
                await loadActiveUsers();

            } catch (error) {
                console.error('‚ùå Initialization failed:', error);
                showError('Failed to initialize. Please refresh and try again.');
            }
        }

        // Show current user info
        function showCurrentUser() {
            if (currentUser) {
                currentUserAvatar.textContent = currentUser.displayName ? currentUser.displayName.charAt(0).toUpperCase() : 'U';
                currentUserName.textContent = currentUser.displayName || `@${currentUser.username}`;
                currentUserInfo.style.display = 'flex';
                loadingState.style.display = 'none';
            }
        }

        // Load active users
        async function loadActiveUsers() {
            try {
                loadingText.textContent = 'Finding active Farcaster users...';
                
                // Simulate API call to get active users
                await new Promise(resolve => setTimeout(resolve, 1000));
                
                // Simulated user data - in real app, this would come from Farcaster API
                activeUsers = [
                    { fid: 1, username: "alex.eth", displayName: "Alex", avatar: "A", postsLast7Days: 3, totalPosts: 42, followers: 128, verified: true },
                    { fid: 2, username: "taytay.eth", displayName: "Taylor", avatar: "T", postsLast7Days: 1, totalPosts: 18, followers: 89, verified: false },
                    { fid: 3, username: "jordan.base", displayName: "Jordan", avatar: "J", postsLast7Days: 1, totalPosts: 67, followers: 215, verified: true },
                    { fid: 4, username: "casey.eth", displayName: "Casey", avatar: "C", postsLast7Days: 5, totalPosts: 124, followers: 342, verified: true }
                ];
                
                // Filter active users
                activeUsers = activeUsers.filter(user => user.postsLast7Days >= 1);
                
                if (activeUsers.length === 0) {
                    showNoActiveUsers();
                    return;
                }
                
                // Show user selection
                userSelection.style.display = 'block';
                renderUserList();
                setupEventListeners();
                
            } catch (error) {
                console.error('‚ùå Failed to load users:', error);
                showError('Failed to load users. Please try again.');
            }
        }

        // Show message when no active users found
        function showNoActiveUsers() {
            loadingState.innerHTML = `
                <div style="font-size: 3rem; margin-bottom: 16px;">üò¥</div>
                <h3 style="margin-bottom: 8px;">No Active Users Found</h3>
                <p style="color: #666;">Check back later when users have posted on Base or Farcaster</p>
                <button onclick="location.reload()" class="submit-btn" style="margin-top: 16px;">Refresh</button>
            `;
        }

        // Render the list of active users
        function renderUserList() {
            userList.innerHTML = '';
            
            activeUsers.forEach(user => {
                const userItem = document.createElement('div');
                userItem.className = 'user-item';
                
                userItem.innerHTML = `
                    <div class="user-item-avatar">${user.avatar}</div>
                    <div>
                        <div style="font-weight: bold;">${user.displayName}</div>
                        <div style="font-size: 0.75rem; color: #666;">@${user.username} ‚Ä¢ ${user.postsLast7Days} posts this week</div>
                    </div>
                    ${user.verified ? '<div style="margin-left: auto; color: #8a63d2;">‚úì</div>' : ''}
                `;
                
                userItem.addEventListener('click', () => selectUser(user));
                userList.appendChild(userItem);
            });
        }

        // Select a user to greet
        function selectUser(user) {
            selectedUser = user;
            
            // Update UI
            document.querySelectorAll('.user-item').forEach(item => {
                item.classList.remove('selected');
            });
            
            const userItems = Array.from(document.querySelectorAll('.user-item'));
            const selectedIndex = activeUsers.findIndex(u => u.fid === user.fid);
            if (selectedIndex !== -1) {
                userItems[selectedIndex].classList.add('selected');
            }
            
            // Update user info
            userAvatar.textContent = user.avatar;
            userName.textContent = `${user.displayName} (@${user.username})`;
            userPosts.textContent = `üìù ${user.totalPosts} posts`;
            userFollowers.textContent = `üë• ${user.followers} followers`;
            
            // Show sections
            selectedUserInfo.style.display = 'flex';
            greetingSection.style.display = 'block';
            
            // Set random greeting
            const randomGreeting = greetingVariants[Math.floor(Math.random() * greetingVariants.length)];
            greetingText.textContent = randomGreeting;
            
            resetForm();
        }

        // Set up event listeners
        function setupEventListeners() {
            emojiButtons.forEach(button => {
                button.addEventListener('click', () => selectEmoji(button));
            });

            replyText.addEventListener('input', updateSubmitButton);
            submitBtn.addEventListener('click', sendGreeting);
            sendAnotherBtn.addEventListener('click', resetToUserSelection);
        }

        // Handle emoji selection
        function selectEmoji(button) {
            emojiButtons.forEach(btn => {
                btn.classList.remove('selected');
                btn.setAttribute('aria-pressed', 'false');
            });
            
            button.classList.add('selected');
            button.setAttribute('aria-pressed', 'true');
            selectedEmoji = button.getAttribute('data-emoji');
            
            updateSubmitButton();
        }

        // Update submit button
        function updateSubmitButton() {
            const hasReaction = selectedEmoji || replyText.value.trim().length > 0;
            submitBtn.disabled = !hasReaction;
        }

        // Send greeting via Farcaster
        async function sendGreeting() {
            if (!selectedUser) return;
            
            try {
                submitBtn.textContent = 'Sending...';
                submitBtn.classList.add('sending');
                submitBtn.disabled = true;
                
                const messageData = {
                    toFid: selectedUser.fid,
                    toUsername: selectedUser.username,
                    greeting: greetingText.textContent,
                    emoji: selectedEmoji,
                    personalMessage: replyText.value.trim(),
                    timestamp: new Date().toISOString()
                };
                
                // Send via Farcaster SDK
                if (farcasterSDK && farcasterSDK.actions && farcasterSDK.actions.sendCast) {
                    const cast = {
                        text: buildGreetingMessage(messageData),
                        embeds: []
                    };
                    await farcasterSDK.actions.sendCast(cast);
                } else {
                    // Fallback: simulate send
                    await new Promise(resolve => setTimeout(resolve, 2000));
                    console.log('‚úÖ Greeting sent (mock):', messageData);
                }
                
                showSuccess();
                
            } catch (error) {
                console.error('‚ùå Failed to send greeting:', error);
                submitBtn.textContent = 'Failed - Try Again';
                submitBtn.classList.remove('sending');
                submitBtn.disabled = false;
                showToast('Failed to send greeting', true);
            }
        }

        // Build greeting message
        function buildGreetingMessage(messageData) {
            let message = `Hey @${messageData.toUsername}! üëã\n\n`;
            message += `${messageData.greeting}\n\n`;
            
            if (messageData.emoji) {
                message += `Reaction: ${messageData.emoji}\n`;
            }
            
            if (messageData.personalMessage) {
                message += `\n${messageData.personalMessage}\n`;
            }
            
            message += `\n- Sent via BaseBros üéâ`;
            
            return message;
        }

        // Show success
        function showSuccess() {
            greetingSection.style.display = 'none';
            selectedUserInfo.style.display = 'none';
            userSelection.style.display = 'none';
            successMessage.style.display = 'block';
            showToast('Greeting sent via Farcaster!');
        }

        // Reset to user selection
        function resetToUserSelection() {
            successMessage.style.display = 'none';
            userSelection.style.display = 'block';
            selectedUserInfo.style.display = 'none';
            greetingSection.style.display = 'none';
            selectedUser = null;
            resetForm();
        }

        // Show toast
        function showToast(message, isError = false) {
            toast.textContent = message;
            toast.className = 'toast' + (isError ? ' error' : '');
            toast.classList.add('show');
            
            setTimeout(() => {
                toast.classList.remove('show');
            }, 4000);
        }

        // Show error
        function showError(message) {
            loadingState.innerHTML = `
                <div style="font-size: 3rem; margin-bottom: 16px;">‚ùå</div>
                <h3 style="margin-bottom: 8px;">Error</h3>
                <p style="color: #666; margin-bottom: 16px;">${message}</p>
                <button onclick="location.reload()" class="submit-btn">Try Again</button>
            `;
        }

        // Reset form
        function resetForm() {
            emojiButtons.forEach(btn => {
                btn.classList.remove('selected');
                btn.setAttribute('aria-pressed', 'false');
            });
            selectedEmoji = null;
            replyText.value = '';
            updateSubmitButton();
            submitBtn.textContent = 'Send Greeting via Farcaster';
            submitBtn.classList.remove('sending');
        }

        // =============================================================================
        // START THE APP
        // =============================================================================
        
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üöÄ BaseBros Farcaster Mini App starting...');
            init();
        });

    </script>

    <!-- Farcaster Frame SDK -->
    <script src="https://unpkg.com/@farcaster/frame-sdk@0.2.2"></script>
</body>
</html>
